# CD Workflow - DÃ©ployer en production

name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: DÃ©ployer en production
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: GÃ©nÃ©rer les donnÃ©es
        run: python data/generate_data.py
      
      - name: EntraÃ®ner le modÃ¨le en production
        run: python src/train.py
      
      - name: Valider la performance
        run: python src/evaluate.py
      
      - name: Uploader les artifacts finaux
        uses: actions/upload-artifact@v3
        with:
          name: production-model
          path: models/
      
      - name: ExÃ©cuter les prÃ©dictions de test
        run: python src/predict.py
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CD PIPELINE â€” DÃ©ploiement Continu du modÃ¨le de Churn ML
#  Fichier : .github/workflows/cd.yml
#
#  Ce pipeline se dÃ©clenche UNIQUEMENT quand :
#  â†’ Le CI Pipeline a rÃ©ussi sur la branche main
#  â†’ Un tag de version est crÃ©Ã© (ex: v1.0.0)
#
#  Il dÃ©ploie le modÃ¨le sous forme d'une API FastAPI.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "CD â€” DÃ©ploiement du modÃ¨le Churn"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DÃ‰CLENCHEURS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  # Se dÃ©clenche quand le CI Pipeline se termine
  workflow_run:
    workflows: ["CI â€” Churn ML Pipeline"]
    branches: [main]
    types:
      - completed   # Quand le CI est terminÃ© (succÃ¨s OU Ã©chec)

  # Permet aussi de dÃ©clencher manuellement depuis GitHub
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement de dÃ©ploiement"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.10"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOBS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : VÃ‰RIFICATION AVANT DÃ‰PLOIEMENT
  # S'assure que le CI a bien rÃ©ussi avant de dÃ©ployer
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-ci-status:
    name: "ðŸ›¡ï¸ VÃ©rification CI"
    runs-on: ubuntu-latest

    # Ne dÃ©ployer QUE si le CI a rÃ©ussi
    # Si le CI a Ã©chouÃ©, on n'entre mÃªme pas dans ce job
    if: >
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: "âœ… CI rÃ©ussi â€” DÃ©ploiement autorisÃ©"
        run: |
          echo "Le CI Pipeline a rÃ©ussi."
          echo "DÃ©ploiement du commit : ${{ github.sha }}"
          echo "Branche : ${{ github.ref }}"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : DÃ‰PLOIEMENT EN STAGING
  # DÃ©ploie sur l'environnement de test (staging)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: "ðŸš€ DÃ©ploiement Staging"
    runs-on: ubuntu-latest
    needs: check-ci-status
    environment: staging   # Environnement GitHub (peut nÃ©cessiter une approbation manuelle)

    steps:
      - name: "ðŸ“¥ Checkout du code"
        uses: actions/checkout@v4

      - name: "ðŸ Installer Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: "ðŸ“¦ Installer les dÃ©pendances"
        run: |
          pip install -r requirements.txt

      # â”€â”€ GÃ©nÃ©rer les donnÃ©es et rÃ©entraÃ®ner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # En production, on tÃ©lÃ©chargerait le modÃ¨le depuis S3 / MLflow
      # Ici on simule l'entraÃ®nement complet pour la dÃ©monstration
      - name: "ðŸ—ƒï¸ GÃ©nÃ©rer les donnÃ©es"
        run: python data/generate_data.py

      - name: "ðŸ‹ï¸ RÃ©entraÃ®ner le modÃ¨le (staging)"
        run: python src/train.py

      - name: "ðŸ“ˆ Valider les performances"
        run: python src/evaluate.py

      # â”€â”€ CrÃ©er l'API de prÃ©diction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # On crÃ©e un script API simple pour servir le modÃ¨le
      - name: "ðŸ”§ PrÃ©parer l'API de dÃ©ploiement"
        run: |
          cat > api.py << 'EOF'
          """
          API de prÃ©diction de Churn â€” crÃ©Ã©e automatiquement par le CD Pipeline.
          Pour utiliser cette API :
            pip install fastapi uvicorn
            python api.py
          Puis envoyer une requÃªte POST Ã  http://localhost:8000/predict
          """
          import json
          import joblib
          import numpy as np

          # Simuler un dÃ©marrage d'API (test de chargement du modÃ¨le)
          model = joblib.load("models/model.pkl")
          scaler = joblib.load("models/scaler.pkl")

          with open("models/metrics.json") as f:
              metrics = json.load(f)

          print("=== API de PrÃ©diction de Churn ===")
          print(f"ModÃ¨le chargÃ© avec succÃ¨s")
          print(f"ROC-AUC : {metrics['roc_auc']}")
          print(f"F1-Score : {metrics['f1_score']}")
          print("API prÃªte Ã  recevoir des prÃ©dictions.")

          # Test de prÃ©diction
          test_input = np.array([[35, 12, 0, 75.0, 900.0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0]])
          test_scaled = scaler.transform(test_input)
          pred = model.predict(test_scaled)[0]
          prob = model.predict_proba(test_scaled)[0][1]
          print(f"Test de prÃ©diction : {'CHURN' if pred == 1 else 'RESTE'} ({prob:.2%})")
          EOF

      # â”€â”€ Tester le dÃ©marrage de l'API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ§ª Tester l'API de prÃ©diction"
        run: |
          python api.py

      # â”€â”€ Sauvegarder le modÃ¨le dÃ©ployÃ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ’¾ Archiver le modÃ¨le de staging"
        uses: actions/upload-artifact@v4
        with:
          name: "model-staging-${{ github.run_number }}"
          # github.run_number = numÃ©ro de build (s'incrÃ©mente Ã  chaque run)
          path: |
            models/
            api.py
          retention-days: 14

      # â”€â”€ RÃ©sumÃ© du dÃ©ploiement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“ RÃ©sumÃ© du dÃ©ploiement Staging"
        run: |
          echo "## ðŸš€ DÃ©ploiement Staging rÃ©ussi !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement** : Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Build** : #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit** : \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          ACCURACY=$(python -c "import json; m=json.load(open('models/metrics.json')); print(f\"{m['accuracy']:.4f}\")")
          echo "- **Accuracy** : $ACCURACY" >> $GITHUB_STEP_SUMMARY


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 : DÃ‰PLOIEMENT EN PRODUCTION
  # Se dÃ©clenche SEULEMENT aprÃ¨s la validation du staging
  # ET uniquement sur la branche main
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: "ðŸ­ DÃ©ploiement Production"
    runs-on: ubuntu-latest
    needs: deploy-staging   # Attend que staging soit OK
    # En production rÃ©elle, tu ajouterais une approbation manuelle ici
    # via : environment: production (avec protection rules dans GitHub)
    if: >
      github.ref == 'refs/heads/main' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: "ðŸ“¥ Checkout du code"
        uses: actions/checkout@v4

      - name: "ðŸ Installer Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: "ðŸ“¦ Installer les dÃ©pendances"
        run: pip install -r requirements.txt

      - name: "ðŸ—ƒï¸ GÃ©nÃ©rer les donnÃ©es"
        run: python data/generate_data.py

      - name: "ðŸ‹ï¸ EntraÃ®ner le modÃ¨le (production)"
        run: python src/train.py

      - name: "ðŸ“ˆ Valider les performances"
        run: python src/evaluate.py

      # â”€â”€ CrÃ©er un tag de version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # On version le modÃ¨le avec le numÃ©ro de build
      - name: "ðŸ·ï¸ CrÃ©er un tag de version"
        run: |
          VERSION="v1.0.${{ github.run_number }}"
          echo "Version du modÃ¨le : $VERSION"
          echo "MODEL_VERSION=$VERSION" >> $GITHUB_ENV

      # â”€â”€ Archiver en production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ’¾ Archiver le modÃ¨le de production"
        uses: actions/upload-artifact@v4
        with:
          name: "model-production-${{ env.MODEL_VERSION }}"
          path: models/
          retention-days: 90   # Garder 90 jours en production

      # â”€â”€ RÃ©sumÃ© final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“ RÃ©sumÃ© du dÃ©ploiement Production"
        run: |
          echo "## ðŸ­ DÃ‰PLOIEMENT PRODUCTION RÃ‰USSI !" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Champ | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.MODEL_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build  | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          ACCURACY=$(python -c "import json; m=json.load(open('models/metrics.json')); print(f\"{m['accuracy']:.4f}\")")
          F1=$(python -c "import json; m=json.load(open('models/metrics.json')); print(f\"{m['f1_score']:.4f}\")")
          AUC=$(python -c "import json; m=json.load(open('models/metrics.json')); print(f\"{m['roc_auc']:.4f}\")")
          echo "| Accuracy | $ACCURACY |" >> $GITHUB_STEP_SUMMARY
          echo "| F1-Score | $F1 |" >> $GITHUB_STEP_SUMMARY
          echo "| ROC-AUC  | $AUC |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Le modÃ¨le est maintenant en production !" >> $GITHUB_STEP_SUMMARY